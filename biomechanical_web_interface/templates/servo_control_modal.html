<!-- Modal Control de C√°mara Servo -->
<div class="modal fade" id="servoControlModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark border-0">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title text-biomech-cyan">
                    <i class="bi bi-camera"></i> Control de C√°mara Servo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" onclick="closeServoControl()"></button>
            </div>
            <div class="modal-body">
                <!-- Instrucciones de Altura -->
                <div class="alert alert-info border-0 mb-4" style="background: rgba(0, 212, 255, 0.1);">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <i class="bi bi-info-circle text-biomech-cyan" style="font-size: 2rem;"></i>
                        </div>
                        <div class="col">
                            <h6 class="text-biomech-cyan mb-2">Posicionamiento de C√°mara</h6>
                            <p class="text-light mb-2">
                                <strong>Altura recomendada para {{ joint_config.name }}:</strong>
                                <span class="text-biomech-green fs-5" id="recommendedHeight">-- cm</span>
                            </p>
                            <small class="text-muted">
                                {% if user and user.height_cm %}
                                Basado en proporciones biomec√°nicas (Drillis-Contini) para tu altura de {{ user.height_cm }}cm
                                {% else %}
                                Basado en proporciones biomec√°nicas (Drillis-Contini). Configure su altura en el perfil para c√°lculos personalizados.
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Estado de Conexi√≥n ESP32 -->
                <div class="row mb-4">
                    <div class="col-12">
                <!-- Estado de Conexi√≥n ESP32 -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="servo-status-card">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <h6 class="text-light mb-1">
                                        <i class="bi bi-wifi"></i> Conexi√≥n ESP32
                                    </h6>
                                    <span id="connectionStatus" class="badge bg-warning">Verificando...</span>
                                    <small class="text-muted d-block" id="connectionDetails">IP: Detectando...</small>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-outline-info btn-sm" onclick="toggleWiFiConfig()" id="wifiConfigBtn">
                                        <i class="bi bi-gear"></i> Config
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="reconnectESP32()">
                                        <i class="bi bi-arrow-clockwise"></i> Reconectar
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Panel de Configuraci√≥n WiFi (Desplegable) -->
                            <div id="wifiConfigPanel" class="wifi-config-panel" style="display: none;">
                                <hr class="text-light">
                                <h6 class="text-light mb-3">üåê Configuraci√≥n WiFi ESP32</h6>
                                
                                <!-- Redes Disponibles -->
                                <div class="mb-3">
                                    <label class="form-label text-light">Redes disponibles:</label>
                                    <div class="d-flex gap-2">
                                        <select class="form-select form-select-sm" id="availableNetworks">
                                            <option value="">Escaneando redes...</option>
                                        </select>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="scanWiFiNetworks()">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- SSID Manual -->
                                <div class="mb-3">
                                    <label for="manualSSID" class="form-label text-light">O escribir SSID manualmente:</label>
                                    <input type="text" class="form-control form-control-sm" id="manualSSID" placeholder="Nombre de la red WiFi">
                                </div>
                                
                                <!-- Password -->
                                <div class="mb-3">
                                    <label for="wifiPassword" class="form-label text-light">Contrase√±a:</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control form-control-sm" id="wifiPassword" placeholder="Contrase√±a de la red">
                                        <button class="btn btn-outline-secondary btn-sm" type="button" onclick="togglePasswordVisibility()">
                                            <i class="bi bi-eye" id="passwordToggleIcon"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Botones de Acci√≥n -->
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-success btn-sm" onclick="saveWiFiConfig()">
                                        <i class="bi bi-check-circle"></i> Conectar
                                    </button>
                                    <button type="button" class="btn btn-secondary btn-sm" onclick="toggleWiFiConfig()">
                                        Cancelar
                                    </button>
                                </div>
                                
                                <div class="mt-2">
                                    <small class="text-warning">
                                        <i class="bi bi-exclamation-triangle"></i>
                                        El ESP32 se reiniciar√° para aplicar la nueva configuraci√≥n
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Controles de Servo -->
                <div class="row">
                    <!-- Control de Nivelaci√≥n (MPU6050 + Servo Vertical) -->
                    <div class="col-md-6">
                        <div class="servo-control-section">
                            <h6 class="text-biomech-purple mb-3">
                                <i class="bi bi-compass"></i> Nivelaci√≥n Autom√°tica
                            </h6>
                            
                            <!-- Estado del Giroscopio -->
                            <div class="gyro-status mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-muted">Inclinaci√≥n actual:</span>
                                    <span class="text-info" id="currentTilt">0.0¬∞</span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-info" id="tiltBar" style="width: 50%"></div>
                                </div>
                            </div>

                            <!-- Control Autom√°tico/Manual -->
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="autoLevelSwitch" checked onchange="toggleAutoLevel()">
                                <label class="form-check-label text-light" for="autoLevelSwitch">
                                    Nivelaci√≥n autom√°tica
                                </label>
                            </div>

                            <!-- Controles Manuales de Inclinaci√≥n -->
                            <div id="manualTiltControls" style="display: none;">
                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-outline-light btn-sm servo-btn" 
                                            onmousedown="moveServo('tilt', 'up')" onmouseup="stopServo('tilt')">
                                        <i class="bi bi-chevron-up"></i> Inclinar Arriba
                                    </button>
                                    <button type="button" class="btn btn-outline-light btn-sm servo-btn" 
                                            onmousedown="moveServo('tilt', 'down')" onmouseup="stopServo('tilt')">
                                        <i class="bi bi-chevron-down"></i> Inclinar Abajo
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Control de Paneo (Servo Horizontal) -->
                    <div class="col-md-6">
                        <div class="servo-control-section">
                            <h6 class="text-biomech-green mb-3">
                                <i class="bi bi-arrow-left-right"></i> Control de Paneo
                            </h6>
                            
                            <!-- Indicador de posici√≥n -->
                            <div class="pan-position mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-muted">Posici√≥n:</span>
                                    <span class="text-success" id="currentPan">0¬∞ (Centro)</span>
                                </div>
                                
                                <!-- üéõÔ∏è SLIDER CONTROL INTERACTIVO -->
                                <div class="position-slider mb-2">
                                    <input type="range" class="form-range" id="panSlider" 
                                           min="-90" max="90" value="0" step="5"
                                           style="background: linear-gradient(to right, #ffc107 0%, #28a745 50%, #ffc107 100%);">
                                    <div class="d-flex justify-content-between text-muted small">
                                        <span>-90¬∞ (Izq)</span>
                                        <span>0¬∞ (Centro)</span>
                                        <span>+90¬∞ (Der)</span>
                                    </div>
                                </div>
                                
                                <!-- Indicador visual adicional -->
                                <div class="position-indicator">
                                    <div class="position-track">
                                        <div class="position-marker" id="panMarker"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Botones de Paneo -->
                            <div class="row g-2">
                                <div class="col-4">
                                    <button type="button" class="btn btn-outline-warning btn-sm w-100 servo-btn" 
                                            onmousedown="moveServo('pan', 'left')" onmouseup="stopServo('pan')">
                                        <i class="bi bi-chevron-left"></i><br>
                                        <small>Izquierda</small>
                                    </button>
                                </div>
                                <div class="col-4">
                                    <button type="button" class="btn btn-outline-info btn-sm w-100" onclick="centerPan()">
                                        <i class="bi bi-bullseye"></i><br>
                                        <small>Centrar</small>
                                    </button>
                                </div>
                                <div class="col-4">
                                    <button type="button" class="btn btn-outline-warning btn-sm w-100 servo-btn" 
                                            onmousedown="moveServo('pan', 'right')" onmouseup="stopServo('pan')">
                                        <i class="bi bi-chevron-right"></i><br>
                                        <small>Derecha</small>
                                    </button>
                                </div>
                            </div>

                            <!-- Paneo R√°pido -->
                            <div class="mt-3">
                                <div class="btn-group w-100" role="group">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPanPosition(-90)">
                                        -90¬∞
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPanPosition(-45)">
                                        -45¬∞
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPanPosition(0)">
                                        0¬∞
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPanPosition(45)">
                                        +45¬∞
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPanPosition(90)">
                                        +90¬∞
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuraciones Guardadas -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="saved-configs">
                            <h6 class="text-biomech-cyan mb-3">
                                <i class="bi bi-bookmark"></i> Configuraciones Guardadas
                            </h6>
                            <div class="row g-2" id="savedConfigs">
                                <!-- Se llenan din√°micamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-outline-warning" onclick="saveCurrentConfig()">
                    <i class="bi bi-bookmark-plus"></i> Guardar Configuraci√≥n
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="resetToDefaults()">
                    <i class="bi bi-arrow-counterclockwise"></i> Resetear
                </button>
                <button type="button" class="btn btn-success" data-bs-dismiss="modal" onclick="closeServoControl()">
                    <i class="bi bi-check-circle"></i> Continuar An√°lisis
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.servo-control-section {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    padding: 1.5rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
    height: 100%;
}

.servo-status-card {
    background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(76, 175, 80, 0.1));
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid rgba(0, 212, 255, 0.2);
}

/* Panel WiFi Config */
.wifi-config-panel {
    background: rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    padding: 15px;
    margin-top: 10px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.wifi-config-panel .form-control,
.wifi-config-panel .form-select {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
}

.wifi-config-panel .form-control:focus,
.wifi-config-panel .form-select:focus {
    background: rgba(255, 255, 255, 0.15);
    border-color: #ffc107;
    box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
    color: white;
}

.wifi-config-panel .form-control::placeholder {
    color: rgba(255, 255, 255, 0.6);
}

.wifi-config-panel select option {
    background: #333;
    color: white;
}

.gyro-status .progress {
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
}

.position-indicator {
    margin-bottom: 1rem;
}

.position-track {
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    position: relative;
    margin-bottom: 0.5rem;
}

.position-marker {
    width: 16px;
    height: 16px;
    background: var(--biomech-green);
    border-radius: 50%;
    position: absolute;
    top: -4px;
    left: 50%;
    transform: translateX(-50%);
    transition: left 0.3s ease;
    border: 2px solid white;
}

.servo-btn:active {
    transform: scale(0.95);
}

.saved-configs {
    background: rgba(255, 255, 255, 0.03);
    border-radius: 8px;
    padding: 1rem;
}

#connectionStatus.connected {
    background-color: #28a745;
}

#connectionStatus.disconnected {
    background-color: #dc3545;
}

#connectionStatus.connecting {
    background-color: #ffc107;
    color: #000;
}
</style>